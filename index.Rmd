---
title: "Foodbank"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard) 
library(kableExtra)
library(lubridate)
library(NHSRplotthedots)
library(plotly)
library(scales) 
library(tidyverse) 
```

```{r Reading in data, echo = FALSE, results = FALSE}
load("data.rda")

# Shapefile of postcode boundaries from https://datashare.ed.ac.uk/handle/10283/2597
# will not read in if I move the file to other folder, will investigate but have used full path for now
data_boundaries <- sf::st_read("C:/Users/anyj1/Downloads/DS_10283_2597/GB_Postcodes/GB_Postcodes/PostalSector.shp") 
```

```{r Setting date variables, echo = FALSE} 
report_date <- Sys.Date() 

report_month <- floor_date(report_date, unit = "month") 
``` 

```{r Wrangling the data, echo = FALSE}
# Formats dates and postcodes for later
data_wrangle <- data %>%
  mutate("Date" = as.Date(Date, format = "%d/%m/%Y"),
         "Week" = floor_date(Date, unit = "week") + 1,
         "Month" = floor_date(Date, unit = "month"),
         "Postcode" = Postcode %>%
           str_to_upper() %>%
           str_replace_all(" ", "") ,
         "postcode_format" = ifelse(nchar(Postcode) == 7,
                                    str_sub(Postcode, 1, 5),
                                    str_sub(Postcode, 1, 4)
                                    )
         ) %>%
  filter(Date < Sys.Date() & Date > as.Date("2023-04-01")) # data quality issues
```

Column {data-width=500}
-----------------------------------------------------------------------

### Map of Requests
```{r Map of Requests}
# Adds spatial data for polygon plotting
data_spatial <- data_wrangle %>%
  filter(Date > report_month) %>%
  count(name = "total", .by = postcode_format) %>%
  rename("postcode_format" = `.by`) %>%
  left_join(data_boundaries, by = c("postcode_format" = "StrSect"))

# Plotting the number of requests by region
data_spatial %>%
  select(geometry, total, Sprawl) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry = geometry, fill = total)) +
  geom_sf_label(aes(geometry = geometry, label = Sprawl)) + 
  theme_void() +
  labs(fill = "Number of Requests")
```

### Monthly summary

```{r Monthly summary table}
# Finding how many new requests this month
first_requests <- data_wrangle %>%
  summarise("first_request" = min(Date, na.rm = FALSE), .by = "ID") %>%
  mutate("first_request_month" = floor_date(first_request, unit = "month")) %>%
  count(first_request_month, name = "First Requests")

# Creates a summary statistics table with a row for each month and a total row. 
# Includes number of adults fed, number of children fed, number of requests made and number of first requests.
data_wrangle %>%
  summarise(across(.cols = c(Adults, Children), .fns = ~ sum(., na.rm = TRUE)),
            across(.cols = c(Date), .fns = ~ n(), .names = "Requests"),
            .by = Month
            ) %>%
  left_join(first_requests, by = c("Month" = "first_request_month")) %>%
  arrange(desc(Month)) %>%
  mutate("Month" = format(Month, "%b %Y")) %>%
  janitor::adorn_totals("row") %>%
  kable(booktabs = TRUE) %>%
  kable_styling(full_width = TRUE)
```

Column {data-width=500}
-----------------------------------------------------------------------

### Weekly requests

```{r Weekly plot}
# Finding how many adults and children fed each week
data_age_group <- data_wrangle %>%
  pivot_longer(names_to = "Group", values_to = "Number", cols = c(Adults, Children)) %>%
  summarise("Total" = sum(as.numeric(Number), na.rm = TRUE), 
            .by = c(Week, Group)
            )

# Plots the number of adults and children fed per week
plot_age_group <- data_age_group %>%
  ggplot(aes(Week, Total, col = Group)) +
  geom_line() +
  scale_x_date(breaks = date_breaks(width = "1 week")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplotly(plot_age_group)
```

### SPC

```{r Weekly SPC}
# Plots SPC chart of weekly number of requests, where improvement is a decrease in the number of requests
data_wrangle %>%
  count(Week, name = "Number of Requests") %>%
  ptd_spc(value_field = `Number of Requests`,
          date_field = Week,
          improvement_direction = "decrease"
          )
```


```{r Notes, eval = FALSE}
# Other things I'd like to add

# should consider different days - monday, thursday or friday

# Consider shiny - for example for when there is more data may want to filter date range - select certain weeks or months to view
# If so, would use something like:
#
# runtime: shiny
#
# Column {.sidebar data-width=200}
# -----------------------------------------------------------------------
# 
# months <- data_wrangle %>%
#   pull(Month) %>%
#   unique() 
# 
# selectInput("variable", 
#             label = "Month",
#             choices = months,
#             selected = report_month
#             )
#
# then like:
# renderPlot({ 
# data_age_group %>%
#     filter(Week >= input$variable) %>%
#   ggplot(aes(Week, Total, col = Group)) +
#   geom_line() #+
#   #scale_x_date(breaks = date_breaks(width = "1 week")) +
#   #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# })
```
