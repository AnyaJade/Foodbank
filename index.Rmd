---
title: "Foodbank"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard) 
library(kableExtra)
library(lubridate)
library(NHSRplotthedots)
library(plotly)
library(readxl)
library(scales) 
library(tidyverse) 
```

```{r Reading in data, echo = FALSE, results = FALSE}

filename <- "C:/Users/ridge/OneDrive/Documents/Anya/Database.xlsx"

if(file.exists(filename)) {
  
  data_base_details <- read_excel(filename,
                                  sheet = "Details"
                                  )

data_base_requests <- read_excel(filename,
                                 sheet = "Requests"
                                 )

 data <- data_base_details %>%
   mutate("ID" = row_number(),
          "Adults" = as.numeric(str_sub(Adults, 1, 1)),
          "Children" = as.numeric(str_sub(Children, 1, 1))
          ) %>%
   left_join(data_base_requests, by = c("Surname", "First names")) %>%
   select(ID, Town, Postcode, Adults, Children, Date) 
 
 # Shapefile of postcode boundaries from: 
    # https://datashare.ed.ac.uk/handle/10283/2597
  # file will not read in if I move the file to other folder
  data_boundaries <- sf::st_read(
    "C:/Users/ridge/Downloads/GB_Postcodes/GB_Postcodes/PostalSector.shp"
  )
 
}else{
  
  load("data.rda")
  
  # Shapefile of postcode boundaries from: 
    # https://datashare.ed.ac.uk/handle/10283/2597
  # file will not read in if I move the file to other folder
  data_boundaries <- sf::st_read(
    "C:/Users/anyj1/Downloads/GB_Postcodes/PostalSector.shp"
    ) 
  
}

data_historic <- read_excel("historic_data.xlsx")
```

```{r Setting date variables, echo = FALSE} 
report_date <- Sys.Date() 

report_month <- floor_date(report_date, unit = "month") 
``` 

```{r Wrangling the data, echo = FALSE}
# Formats dates and postcodes for later
data_wrangle <- data %>%
  mutate("Date" = as.Date(Date, format = "%d/%m/%Y"),
         "Week" = floor_date(Date, unit = "week") + 1,
         "Month" = floor_date(Date, unit = "month"),
         "Postcode" = Postcode %>%
           str_to_upper() %>%
           str_replace_all(" ", "") ,
         "postcode_format" = ifelse(nchar(Postcode) == 7,
                                    str_sub(Postcode, 1, 5),
                                    str_sub(Postcode, 1, 4)
                                    )
         ) %>%
  filter(Date < Sys.Date() & Date > as.Date("2023-04-01")) # data quality issues
```

Map
===

Column {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r Dropdown for map}
months <- data_wrangle %>%
  pull(Month) %>%
  unique() %>%
  format("%b %Y") %>%
  as.character()

selectInput("variable_map",
            label = "Month",
            choices = c(months, "Last 3 months", "Last 6 months", "Last 12 months", "All time"),
            selected = report_month %>%
              format("%b %Y") %>%
              as.character()
            )
```



Column {data-width=500}
-----------------------------------------------------------------------

### Map of Requests
```{r Map of Requests}
# Plotting the number of requests by region
renderPlot({
  # Adds spatial data for polygon plotting
  
  data_spatial <- data_wrangle %>%
    mutate("input_variable_map_mod" = ifelse(grepl("20", input$variable_map), 
                                         lubridate::my(input$variable_map), 
                                         NA
                                         )
           ) %>%
    filter(case_when(input$variable_map == "Last 3 months" 
                       ~ Month > report_month - months(3),
                     input$variable_map == "Last 6 months" 
                       ~ Month > report_month - months(6),
                     input$variable_map == "Last 12 months" 
                       ~ Month > report_month - years(1),
                     input$variable_map == "All time"
                       ~ Month > as.Date("2000-01-01"),
                     TRUE ~ Month == input_variable_map_mod
                     )
           ) %>%
    count(name = "total", .by = postcode_format) %>%
    rename("postcode_format" = `.by`) %>%
    left_join(data_boundaries, by = c("postcode_format" = "StrSect"))
  
  data_spatial %>%
    select(geometry, total, Sprawl) %>%
    mutate("label" = paste(Sprawl, "\n", total)) %>%
    ggplot() +
    geom_sf(mapping = aes(geometry = geometry, fill = total)) +
  #  scale_fill_viridis_c(option = "plasma")+
    geom_sf_label(aes(geometry = geometry, label = label)) + 
    theme_void() +
    labs(fill = "Number of Requests") 
  
  }
  
)
```


Monthly Summary
===
Column {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r Drop down for monthly}
months <- data_wrangle %>%
  pull(Month) %>%
  unique() %>%
  format("%b %Y") %>%
  as.character()

selectInput("variable_month",
            label = "Month",
            choices = c(months, "Last 3 months", "Last 6 months", "Last 12 months", "All time"),
            selected = "Last 12 months"
            )
```

Column {data-height=350}
-------------------------------------
### Monthly summary



```{r Monthly summary table}
# Finding how many new requests this month
first_requests <- data_wrangle %>%
  summarise("first_request" = min(Date, na.rm = FALSE), .by = "ID") %>%
  mutate("first_request_month" = floor_date(first_request, unit = "month")) %>%
  count(first_request_month, name = "First Requests")

# Creates a summary statistics table with a row for each month and a total row. 
# Includes number of adults fed, number of children fed, number of requests made 
  # and number of first requests.
data_historic_month <- data_historic %>%
  filter(Date < as.Date("2023-04-01")) %>%
  mutate("Month" = floor_date(Date, unit = "month")) %>%
  summarise(across(.cols = c(Adults, Children, Households), 
                   .fns = ~ sum(., na.rm = TRUE)
                   ),
            .by = Month
            ) %>%
  mutate(Requests = NA, `First Requests` = NA)

data_monthly <- data_wrangle %>%
  select(Month, Adults, Children, ID, Date) %>%
  filter(Month >= report_month - months(13)) %>%
  summarise(across(.cols = c(Adults, Children), .fns = ~ sum(., na.rm = TRUE)),
            across(.cols = ID, .fns = ~ n_distinct(.), .names = "Households"),
            across(.cols = Date, .fns = ~ n(), .names = "Requests"),
            .by = Month
            ) %>%
  left_join(first_requests, by = c("Month" = "first_request_month")) %>%
  rbind(data_historic_month) %>%
  arrange(desc(Month))  


renderTable(
  {

  data_monthly %>%
        mutate("input_variable_mod" = ifelse(grepl("20", input$variable_month),
                                             lubridate::my(input$variable_month), 
                                             NA
                                             )
               ) %>%
        filter(case_when(input$variable_month == "Last 3 months" 
                           ~ Month > report_month - months(3),
                         input$variable_month == "Last 6 months" 
                           ~ Month > report_month - months(6),
                         input$variable_month == "Last 12 months" 
                           ~ Month > report_month - years(1),
                         input$variable_month == "All time"
                           ~ Month > as.Date("2000-01-01"),
                         TRUE ~ Month >= input_variable_mod
                         )
               ) %>%
    mutate("Month" = format(Month, "%b %Y")) %>%
    janitor::adorn_totals("row") %>%
    select(-input_variable_mod)
    
  }

)
```

Column {data-height=350}
-------------------------------------

### Adults, Children and Households

```{r Plot monthly group}
renderPlotly(
  
    {ggplotly(data_monthly %>%
                mutate("input_variable_mod" = ifelse(grepl("20", input$variable_month),
                                                     lubridate::my(input$variable_month), 
                                                     NA
                                                     )
                       ) %>%
                filter(case_when(input$variable_month == "Last 3 months" 
                                   ~ Month > report_month - months(3),
                                 input$variable_month == "Last 6 months" 
                                   ~ Month > report_month - months(6),
                                 input$variable_month == "Last 12 months" 
                                   ~ Month > report_month - years(1),
                                 input$variable_month == "All time"
                                   ~ Month > as.Date("2000-01-01"),
                                 TRUE ~ Month >= input_variable_mod
                                 )
                       ) %>%
                pivot_longer(cols = c(Adults, Children, Households),
                             names_to = "Group",
                             values_to = "Value"
                             ) %>%
                ggplot(aes(Month, Value, group = Group, col = Group)) +
                geom_line() +
                theme_bw() +
                ylab("Number"))
      
        }
    
    )
```

### Monthly Requests

```{r Plot monthly request type}
renderPlotly(
  
    {
      
      ggplotly(
        plot_monthly_requests <- data_monthly %>%
          mutate("input_variable_mod" = ifelse(grepl("20", input$variable_month),
                                               lubridate::my(input$variable_month), 
                                               NA
                                               )
                 ) %>%
          filter(case_when(input$variable_month == "Last 3 months" 
                             ~ Month > report_month - months(3),
                           input$variable_month == "Last 6 months" 
                             ~ Month > report_month - months(6),
                           input$variable_month == "Last 12 months" 
                             ~ Month > report_month - years(1),
                           input$variable_month == "All time"
                             ~ Month > as.Date("2000-01-01"),
                           TRUE ~ Month >= input_variable_mod
                           )
                 ) %>%
          pivot_longer(cols = c(Requests, `First Requests`),
                       names_to = "Group",
                       values_to = "Value"
                       ) %>%
          ggplot(aes(Month, Value, fill = Group)) +
          geom_bar(stat = "identity") +
          theme_bw() +
          ylab("Number") + scale_fill_manual(values = c("#E69F00", "#CC79A7")))
      
        }
    
    )
```



Weekly charts
===

Column {.sidebar data-width=200}
-----------------------------------------------------------------------



```{r Drop down for weekly}
months <- data_wrangle %>%
  pull(Month) %>%
  unique() %>%
  format("%b %Y") %>%
  as.character()

selectInput("variable_week",
            label = "Month",
            choices = c(months, "Last 3 months", "Last 6 months", "Last 12 months", "All time"),
            selected = "Last 3 months"
            )
```


Column {data-width=400}
-----------------------------------------------------------------------

### Weekly requests

```{r Weekly plot}
data_weekly <- data_wrangle %>%
  summarise(across(.cols = c(Adults, Children), .fns = ~ sum(., na.rm = TRUE)),
            across(.cols = ID, .fns = ~ n_distinct(.), .names = "Households"),
            across(.cols = Date, .fns = ~ n(), .names = "Requests"),
            .by = Week
            ) 

renderPlotly(
  
  {
    
    ggplotly(data_weekly %>%
               select(-Requests) %>%
               pivot_longer(c(Adults, Children, Households),
                            names_to = "Group",
                            values_to = "Total"
                            ) %>%
               mutate("input_variable_mod" = ifelse(grepl("20", input$variable_week),
                                                    lubridate::my(input$variable_week), 
                                                    NA
                                                    )
                      ) %>%
               filter(case_when(input$variable_week == "Last 3 months" 
                                  ~ Week > report_month - months(3),
                                input$variable_week == "Last 6 months" 
                                  ~ Week > report_month - months(6),
                                input$variable_week == "Last 12 months" 
                                  ~ Week > report_month - years(1),
                                input$variable_week == "All time"
                                  ~ Week > as.Date("2000-01-01"),
                                TRUE ~ Week >= input_variable_mod
                                )
                      ) %>%
               ggplot(aes(Week, Total, col = Group)) +
               geom_line() +
               scale_x_date(breaks = date_breaks(width = "1 week")) +
               theme_bw() +
               theme(axis.text.x = element_text(angle = 45, 
                                                vjust = 0.5, 
                                                hjust = 1
                                                )
                     )
             )
    }
  
)
```

### SPC

```{r Weekly SPC}
# Plots SPC chart of weekly number of requests, where improvement is a decrease 
  # in the number of requests
renderPlotly(
  {
    
    data_weekly %>%
      ptd_spc(value_field = Requests,
              date_field = Week,
              improvement_direction = "decrease"
              ) %>%
      ptd_create_plotly(point_size = 2)
    
  }
)
```

Column {data-width=100}
-----------------------------------------------------------------------

```{r Weekly averages}

renderTable(
  {
    
    data_weekly %>%
      mutate("input_variable_mod" = ifelse(grepl("20", input$variable_week),
                                           lubridate::my(input$variable_week), 
                                           NA
                                           )
             ) %>%
      filter(case_when(input$variable_week == "Last 3 months" 
                         ~ Week > report_month - months(3),
                       input$variable_week == "Last 6 months" 
                         ~ Week > report_month - months(6),
                       input$variable_week == "Last 12 months" 
                         ~ Week > report_month - years(1),
                       input$variable_week == "All time"
                         ~ Week > as.Date("2000-01-01"),
                       TRUE ~ Week >= input_variable_mod
                       )
             ) %>%
      pivot_longer(cols = c(Adults, Children, Households, Requests),
                   names_to = "Group",
                   values_to = "value") %>%
      summarise("Mean" = mean(value) %>% round(2),
                "sd" = sd(value) %>% round(2),
                "Median" = median(value),
                "Min" = min(value),
                "Max" = max(value),
                .by = Group
                ) 
    
    }
  
  )
```

### Days

```{r}
#Monday, Friday
```


```{r Notes, eval = FALSE}
# Other things I'd like to add

# should consider different days - monday, thursday or friday

# Date last refreshed

# Notes/explanations?

# Percentage increase

```
