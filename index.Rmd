---
title: "Foodbank"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard) 
library(kableExtra)
library(lubridate)
library(NHSRplotthedots)
library(plotly)
library(scales) 
library(tidyverse) 
```

```{r Reading in data, echo = FALSE, results = FALSE}
load("C:/Users/anyj1/OneDrive/Desktop/Foodbank/data.rda")

# Shapefile of postcode boundaries from https://datashare.ed.ac.uk/handle/10283/2597
data_boundaries <- sf::st_read("C:/Users/anyj1/Downloads/DS_10283_2597/GB_Postcodes/GB_Postcodes/PostalSector.shp")
```

```{r Setting date variables, echo = FALSE}
report_date <- Sys.Date()
report_month <- floor_date(report_date, unit = "month")
```

```{r Wrangling the data, echo = FALSE}
data_wrangle <- data %>%
  mutate("Date" = as.Date(Date, format = "%d/%m/%Y"),
         "Week" = floor_date(Date, unit = "week") + 1,
         "Month" = floor_date(Date, unit = "month"),
         "Postcode" = Postcode %>%
           str_to_upper() %>%
           str_replace_all(" ", "") ,
         "postcode_format" = ifelse(nchar(Postcode) == 7,
                                    str_sub(Postcode, 1, 5),
                                    str_sub(Postcode, 1, 4))
         ) %>%
  filter(Date < Sys.Date() & Date > as.Date("2023-04-01")) # data quality issues!

data_spatial <- data_wrangle %>%
  count(name = "total", .by = postcode_format) %>%
  rename("postcode_format" = `.by`) %>%
  left_join(data_boundaries, by = c("postcode_format" = "StrSect"))

data_demo <- data_wrangle %>%
  pivot_longer(names_to = "Group", values_to = "Number", cols = c(Adults, Children)) %>%
  summarise("Total" = sum(as.numeric(Number), na.rm = TRUE), .by = c(Week, Group))
```


Column {data-width=500}
-----------------------------------------------------------------------

### Chart A
```{r Map of Requests}
data_spatial %>%
  select(geometry, total, Sprawl) %>%
  ggplot() +
  geom_sf(mapping = aes(geometry = geometry, fill = total)) +
  geom_sf_label(aes(geometry = geometry, label = Sprawl)) + 
  theme_void() +
  labs(fill = "Number of Requests")
```

Column {data-width=500}
-----------------------------------------------------------------------

### Chart B

```{r}
datebreaks <- seq(min(data_demo$Week), max(data_demo$Week), by = "week")

p <- data_demo %>%
  ggplot(aes(Week, Total,col = Group)) +
  geom_line() + 
  scale_x_date(breaks = datebreaks) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplotly(p)
```

### Chart C

```{r}
# per month, number of requests, number of adults, number of children, number new requesters
first_requests <- data_wrangle %>%
  summarise("first_request" = min(Date, na.rm = FALSE), .by = "ID") %>%
  mutate("first_request_month" = floor_date(first_request, unit = "month")) %>%
  count(first_request_month, name = "First Requests")


data_wrangle %>%
  summarise(across(.cols = c(Adults, Children), .fns = ~ sum(., na.rm = TRUE)),
            across(.cols = c(Date), .fns = ~ n(), .names = "Requests"),
            .by = Month
            ) %>%
  left_join(first_requests, by = c("Month" = "first_request_month")) %>%
  arrange(desc(Month)) %>%
  mutate("Month" = format(Month, "%b %Y")) %>%
  janitor::adorn_totals("row") %>%
  kable(booktabs = TRUE) 
```

